<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance measurement</title>
    <script>
const BUCKET_RANGE = 10;

let data;

function compute() {
  const numberOfLoops = document.querySelector('#loopCount').value;
  const eventSource = new EventSource(`http://localhost:8080/compute/${numberOfLoops}`);
  const progress = document.querySelector('.progress');
  data = [];

  eventSource.addEventListener('progress', (event) => {
    const chunk = JSON.parse(event.data);
    data.push(chunk);
    progress.innerHTML = `sample count: ${chunk.sampleCount}, cycles: ${chunk.cycles}, time spent: ${chunk.timeSpent}`;
  });

  eventSource.addEventListener('done', () => {
    eventSource.close();
    progress.innerHTML = 'Analyzing data...';
    setTimeout(analyze, 0);
  });
}

class TimeBucket {
  #count = 0;
  #ranges = [];
  #maxHit = 0;
  #min = Number.POSITIVE_INFINITY;
  #mean = 0;
  #max = 0;

  get min () {
    return this.#min;
  }

  get mean () {
    return this.#mean;
  }

  get max () {
    return this.#max;
  }

  add (duration) {
    ++this.#count;
    const index = Math.floor(duration / BUCKET_RANGE);
    if (isNaN(index)) {
      debugger;
    }
    if (!this.#ranges[index]) {
      this.#ranges[index] = 1;
    } else {
      ++this.#ranges[index];
    }
    this.#maxHit = Math.max(this.#ranges[index], this.#maxHit);
  }

  clean () {
    const threshold = Math.ceil(this.#count / 100);
    let sum = 0;
    let count = 0;
    for (let index = 0; index < this.#ranges.length; ++index) {
      const value = this.#ranges[index] ?? 0;
      if (value < threshold) {
        delete this.#ranges[index];
      } else {
        this.#min = Math.min(this.#min, index);
        this.#max = Math.max(this.#max, index);
        sum += value * index;
        count += value;
      }
    }
    this.#mean = Math.floor(sum / count);
  }

  ratio (index) {
    return (this.#ranges[index] ?? 0)/ this.#maxHit;
  }
}

const buckets = {};

function analyze() {
  for (const { measures } of data) {
    for (const measure of measures.split(/[,|]/)) {
      const [,type, name, operatorState, baseDuration] = measure.match(/(\w)(?::([^=@]+))?(?:@(-?\d+))?=(\d+)/)
      const duration = Number.parseInt(baseDuration);
      if (type === 'p') {
        if (!buckets['-parser-']) {
          buckets['-parser-'] = new TimeBucket();
        }
        buckets['-parser-'].add(duration);
      } else if (type === 'o') {
        if (!buckets[`-${name}-`]) {
          buckets[`-${name}-`] = new TimeBucket();
        }
        buckets[`-${name}-`].add(duration);
      }
    }
  }

  const keys = Object.keys(buckets).sort();
  const tbody = document.querySelector('tbody');
  tbody.innerHTML = '';
  for (const key of keys) {
    const bucket = buckets[key];
    bucket.clean();
    const row = tbody.appendChild(document.createElement('tr'));
    row.appendChild(document.createElement('td')).innerHTML = key;
    const bars = [];
    const colors = [
      '#FFFFFF', // White
      '#FFCCCC',
      '#FF9999',
      '#FF6666',
      '#FF3333',
      '#FF0000', // Red
      '#CC0000',
      '#990000',
      '#660000',
      '#330000'
    ];
    for (let index = 0; index < 100; ++index) {
      const ratio = bucket.ratio(index);
      if (ratio > 0) {
        const color = ratio === 1 ? colors.at(-1) : colors[Math.floor(ratio * colors.length)];
        bars.push(`<rect x="${index}" y="0" width="1" height="20" fill="${color}"/>`)
      }
    }
    row.appendChild(document.createElement('td')).innerHTML = `<svg width="100" height="20" version="1.1" xmlns="http://www.w3.org/2000/svg">${bars.join('')}</svg>`;
    row.appendChild(document.createElement('td')).innerHTML = bucket.min;
    row.appendChild(document.createElement('td')).innerHTML = bucket.mean;
    row.appendChild(document.createElement('td')).innerHTML = bucket.max;
  }

  document.querySelector('.progress').innerHTML = '';
  for (const span of document.querySelectorAll('.bucket_range')) {
    span.innerHTML = BUCKET_RANGE.toString();
  }
}
    </script>
  </head>
  <body>
    <h1>Performance measurement</h1>
    <label for="loopCount">Select number of loops:</label>
    <select id="loopCount">
        <option value="1">1</option>
        <option value="10">10</option>
        <option value="100">100</option>
        <option value="500">500</option>
        <option value="1000">1000</option>
    </select>
    <button onclick="compute()">Compute</button>
    <div class="progress"></div>
    <table>
      <thead>
        <tr>
          <th>instruction</th>
          <th>bucket (0-100)</th>
          <th>min (x <span class="bucket_range"></span>ns)</th>
          <th>mean (x <span class="bucket_range"></span>ns)</th>
          <th>max (x <span class="bucket_range"></span>ns)</th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>
  </body>
</html>