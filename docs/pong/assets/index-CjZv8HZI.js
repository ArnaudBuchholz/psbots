(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const o of a.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&n(o)}).observe(document,{childList:!0,subtree:!0});function t(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function n(i){if(i.ep)return;i.ep=!0;const a=t(i);fetch(i.href,a)}})();const A="system",Ke="user";function*ye(s){const{length:e}=s;for(let t=0;t<e;++t)yield s.at(t)}var r;(function(s){s.null="null",s.boolean="boolean",s.integer="integer",s.string="string",s.name="name",s.mark="mark",s.operator="operator",s.array="array",s.dictionary="dictionary"})(r||(r={}));const h={type:r.null,isReadOnly:!0,isExecutable:!1};class Te extends Error{constructor(e,t){super(e),this.name="AssertionFailed",this.cause=t}}function u(s,e,t){if(typeof s!="boolean"){if(!s.success)throw new Te("Unexpected failed result",s.exception)}else if(!s)throw new Te(e??"assertion failed",t)}function T(s,{source:e,filename:t,pos:n,length:i}){return t===void 0?s:Object.assign({debugSource:{source:e,filename:t,pos:n,length:i},...s})}function*ht(s){const{source:e,pos:t}=s,n=e.indexOf('"',t+1);return n===-1?(yield T(h,{...s,length:1}),e.length):(yield T({type:r.string,isReadOnly:!0,isExecutable:!1,string:e.slice(t+1,n)},{...s,length:n-t+1}),n+1)}function*ft(s){const{source:e,pos:t}=s,n=e[t];u(n!==void 0);let i=t+1;for(;i<e.length&&"0123456789".includes(e[i]);)++i;return i===t+1&&"+-".includes(n)?(yield T({type:r.name,isReadOnly:!0,isExecutable:!0,name:n},{...s,length:1}),i):(yield T({type:r.integer,isReadOnly:!0,isExecutable:!1,integer:Number.parseInt(e.slice(t,i))},{...s,length:i-t}),i)}function*yt(s){const{source:e,pos:t}=s,{length:n}=e,i=e[t];if(u(i!==void 0),"[]{}«»".includes(i))return yield T({type:r.name,isReadOnly:!0,isExecutable:!0,name:i},{...s,length:1}),t+1;if(t===n-1)return yield i==="/"?T({type:r.name,isReadOnly:!0,isExecutable:!0,name:""},{...s,length:1}):T({type:r.name,isReadOnly:!0,isExecutable:!0,name:i},{...s,length:1}),t+1;let a=t+1;const o=e[a];if(u(o!==void 0),i===o&&"<>".includes(i))return yield T({type:r.name,isReadOnly:!0,isExecutable:!0,name:i==="<"?"<<":">>"},{...s,length:2}),a+1;for(;a<n;){const c=e[a];if(u(c!==void 0),` 	\r
%[]{}«»<>`.includes(c))break;++a}return yield i==="/"?T({type:r.name,isReadOnly:!0,isExecutable:!1,name:e.slice(t+1,a)},{...s,length:a-t}):T({type:r.name,isReadOnly:!0,isExecutable:!0,name:e.slice(t,a)},{...s,length:a-t}),a}function*me(s,e){e=e??{};const{filename:t}=e;let{pos:n=0}=e;const{length:i}=s;for(;n<i;){const a=s[n];if(u(a!==void 0),` 	\r
`.includes(a)){++n;continue}if(a==="%"){if(n=s.indexOf(`
`,n),n===-1)return;++n;continue}a==='"'?n=yield*ht({source:s,filename:t,pos:n}):"-+0123456789".includes(a)?n=yield*ft({source:s,filename:t,pos:n}):n=yield*yt({source:s,filename:t,pos:n})}}const ge={type:r.mark,isReadOnly:!0,isExecutable:!1};function se(s,e){if(s.type!==r.integer)return{success:!1,exception:"typeCheck"};const{integer:t}=s;return t<0||t>=e?{success:!1,exception:"rangeCheck"}:{success:!0,value:t}}function mt(s){return typeof s=="object"&&s!==null}const gt={[r.string]:{isReadOnly:!0},[r.operator]:{isReadOnly:!0,isExecutable:!0}};function _t(s){const e=["isReadOnly","isExecutable"],t=gt[s.type];for(const n of e){const i=t&&t[n];if(i!==void 0){if(s[n]!==i)return!0}else if(typeof s[n]!="boolean")return!0}return!1}function bt({isReadOnly:s,isExecutable:e},{isReadOnly:t,isExecutable:n}={}){return t!==void 0&&s!==t?!1:n===void 0||e===n}function kt(s,e,t,n){return mt(e)&&e.type===s&&!_t(e)&&bt(e,t)&&n(e)}function xt(s){return typeof s=="number"&&s%1===0}const Ae=(s,e)=>typeof s=="function"&&s.length===e,vt=s=>xt(s)&&s>=0;function St(s,e){return kt(r.array,s,e,({isReadOnly:t,array:n})=>n!==void 0&&vt(n.length)&&Ae(n.at,1)&&(t||Ae(n.set,2)))}function ae(s){let e=0;for(;e<s.length&&s.at(e).type!==r.mark;)++e;return e===s.length?{success:!1,exception:"unmatchedMark"}:{success:!0,value:e}}const I=Number.POSITIVE_INFINITY,m=0,S=-1,M=Number.NEGATIVE_INFINITY;var B;(function(s){s[s.constant=0]="constant",s[s.implementation=1]="implementation"})(B||(B={}));const Ot=1e3;function Rt(s,e){u(s);const{maxIterations:t=Ot}={},n=s.value;let i=0;for(;i<t;){const{done:a}=n.next();if(++i,a===!0)break}return i}const wt="␀",Q="▻",$="◅";function Et(s,e){let t=1,n=0,i=s.indexOf(`
`);for(;i!==-1&&n+e>i;)++i,e-=i-n,n=i,++t,i=s.indexOf(`
`,n);return{line:t,col:e+1}}function Tt(s){const e=s.lastIndexOf("/"),t=s.lastIndexOf("\\"),n=Math.max(e,t);return n===-1?s:"…"+s.slice(n)}function At(s,e){const t=s.indexOf(Q),n=s.indexOf($,t+1),i=n-t+1;if(t>-1&&n>-1&&i>0)if(e>i){let a=t-Math.ceil((e-i)/2);if(a+e>s.length&&(a=s.length-e+1),a>0)return"…"+s.slice(Math.max(0,a))}else return"…"+s.slice(Math.max(0,t-1));return s}function It(s,e,t){let n=e===void 0?s:`${s}@${e}`;if(t<1||n.length<=t)return n;let i="";if(e!==void 0){if(i=`@${Tt(e)}`,n=`${s}${i}`,n.length<=t)return n;t<i.length?i="":t-=i.length}return s=At(s,t),s.length>t&&(s=s.slice(0,Math.max(0,t-1))+"…"),i?`${s}${i}`:s}function N(s,e,{includeDebugSource:t=!1,maxWidth:n=0}){let i;if(e!==void 0&&t){const{filename:a,source:o}=e,{line:c,col:p}=Et(o,e.pos);i=`${a}:${c}:${p}`}return It(s,i,n)}const Je={[r.null]:({debugSource:s},e)=>N(wt,s,e),[r.boolean]:({isSet:s,debugSource:e},t)=>N(s?"true":"false",e,t),[r.integer]:({integer:s,debugSource:e},t)=>N(s.toString(),e,t),[r.string]:({isExecutable:s,string:e,debugSource:t},n)=>{var a;let i;if(s){const{operatorState:o}=n;if(o!==void 0&&o>=m){const[c]=me(e,{pos:o,filename:"toString"}),p=(a=c==null?void 0:c.debugSource)==null?void 0:a.length;p!==void 0&&(i=e.slice(0,Math.max(0,o))+Q+e.slice(o,o+p)+$+e.slice(Math.max(0,o+p)))}i||(i=e)}else i=JSON.stringify(e);return N(i,t,n)},[r.name]:({isExecutable:s,name:e,debugSource:t},n)=>{let i=e.replaceAll(" ","␣");return s||(i=`/${i}`),N(i,t,n)},[r.mark]:({debugSource:s},e)=>N("--mark--",s,e),[r.operator]:({operator:s,debugSource:e},t)=>{let n=`-${s.name}-`;const{operatorState:i}=t;return i!==void 0&&i!==I&&(i>m?n+=`${Q}${i==null?void 0:i.toString()}`:i===S?n+=$:i===M?n+=`${$}${$}`:i<S&&(n+=`${$}${i==null?void 0:i.toString()}`)),N(n,e,t)},[r.array]:({isExecutable:s,array:e,debugSource:t},n)=>{const i=[];s?i.push("{"):i.push("[");const{length:a}=e,{operatorState:o}=n;for(let c=0;c<a;++c){const p=e.at(c),d=Je[p.type](p,Object.assign({},n,{includeDebugSource:!1,maxWidth:0,operatorState:I}));s&&o===c?i.push(Q+d+$):i.push(d)}return s?i.push("}"):i.push("]"),N(i.join(" "),t,n)},[r.dictionary]:({dictionary:s,isReadOnly:e,debugSource:t},n)=>{let a=s.names.length.toString().toString();return e||(a+="/∞"),N(`--dictionary(${a})--`,t,n)}};function _e(s,e){return Je[s.type](s,e??{includeDebugSource:!1,maxWidth:0})}function Ct(s,e){const{length:t}=s,n=[];for(let i=0;i<t;++i){const a=s.at(i),o=s.operatorStateAt(i);n.push(_e(a,Object.assign({},e,{operatorState:o})))}return n}function x(s){return{type:r.boolean,isExecutable:!1,isReadOnly:!0,isSet:s}}function v(s){return s%1!==0||s<Number.MIN_SAFE_INTEGER||s>Number.MAX_SAFE_INTEGER?{success:!1,exception:"undefinedResult"}:{success:!0,value:{type:r.integer,isExecutable:!1,isReadOnly:!0,integer:s}}}function Y(s,{isExecutable:e=!1,tracker:t}={}){return t?{type:r.string,isExecutable:e,isReadOnly:!0,string:s,tracker:t}:{type:r.string,isExecutable:e,isReadOnly:!0,string:s}}function Ze(s,{isExecutable:e=!1,tracker:t}={}){return t?{type:r.name,isExecutable:e,isReadOnly:!0,name:s,tracker:t}:{type:r.name,isExecutable:e,isReadOnly:!0,name:s}}const Mt={[r.null]:()=>null,[r.boolean]:s=>s.isSet,[r.integer]:s=>s.integer,[r.string]:s=>s.string,[r.name]:s=>s.name,[r.mark]:()=>null,[r.operator]:s=>s.operator,[r.array]:s=>s.array,[r.dictionary]:s=>s.dictionary};function Nt(s){return Mt[s.type](s)}function G(...s){return s.map(e=>Nt(e))}const q={};function l(s,e){var i;u(!q[s.name],`Operator ${s.name} is not defined`),Object.freeze(s);const t={type:B.implementation,name:s.name,typeCheck:(i=s.signature)==null?void 0:i.input,implementation:e},n={type:r.operator,isExecutable:!0,isReadOnly:!0,operator:t};if(q[s.name]={definition:s,value:n},s.aliases)for(const a of s.aliases)q[a]={definition:s,value:{...n,operator:{...n.operator,name:a}}};return n}function oe(s,e){const t={type:B.constant,name:s.name,constant:e};q[s.name]={definition:s,value:{type:r.operator,isExecutable:!0,isReadOnly:!0,operator:t}}}const Ie="string",Qe=4,Pt=4,Lt=32,ue=s=>new TextEncoder().encode(s).length+1,Ce=Symbol("MemoryTracker::MemoryPointer");function ne(s,e){return{bytes:(s.bytes??0)+(e.bytes??0),integers:(s.integers??0)+(e.integers??0),pointers:(s.pointers??0)+(e.pointers??0),values:(s.values??0)+(e.values??0)}}function le(s){const{bytes:e=0,integers:t=0,pointers:n=0,values:i=0}=s;return e+t*Qe+n*Pt+i*Lt}class F{_total=1/0;_used=0;_peak=0;_byType={system:0,user:0,string:0};_containers=[];_byContainers;constructor(e={}){const{total:t=1/0}=e;this._total=t,e.debug&&(this._byContainers=new WeakMap)}isAvailable(e,t){u(!!t);const n=le(e);return u(n>0),this._used+n<=this._total?{success:!0,value:n}:{success:!1,exception:"vmOverflow"}}allocate(e,t,n){u(t!=="string");const i=this.isAvailable(e,t);if(!i.success)return i;const{value:a}=i;return this.register(a,t,n),{success:!0,value:{[Ce]:!0,bytes:a,type:t}}}release({bytes:e,type:t},n){this.register(-e,t,n)}register(e,t,n){if(e>0){if(this._used+e>this._total)return{success:!1,exception:"vmOverflow"}}else u(e<this._used);if(this._byType[t]+=e,this._used+=e,this._peak=Math.max(this._used,this._peak),this._byContainers&&n!==this){let i=this._byContainers.get(n);if(i===void 0){const a=new WeakRef(n);i={container:a,type:t,total:0,calls:[]},this._containers.push(a),this._byContainers.set(n,i)}if(u(i.type===t,"Unexpected memory type change",{bytes:e,type:t,container:n}),i.total+=e,u(i.total>=0,"Invalid memory registration",{bytes:e,type:t,container:n}),i.total===0){const a=this._containers.findIndex(o=>o.deref()===n);this._containers.splice(a,1),this._byContainers.delete(n)}else{let a;try{throw new Error("Capture call stack")}catch(o){a=o.stack}i.calls.push({bytes:e,type:t,stack:a})}}return{success:!0,value:void 0}}*enumContainersAllocations(){if(this._byContainers!==void 0)for(const e of this._containers)yield this._byContainers.get(e.deref())}_strings=new Map;addStringRef(e){let t=this._strings.get(e)??0;if(t===0){const n=ue(e),i=this.register(le({bytes:n,integers:1}),Ie,this);if(!i.success)return i}return this._strings.set(e,++t),{success:!0,value:t}}releaseString(e){const t=this._strings.get(e);if(u(t!==void 0,"Unable to release string as it is not referenced",e),t===1){const n=ue(e);return this.release({[Ce]:!0,bytes:le({bytes:n,integers:1}),type:Ie},this),this._strings.delete(e),!1}return this._strings.set(e,t-1),!0}get used(){return this._used}get peak(){return this._peak}get total(){return this._total}get byType(){return this._byType}snapshot(){const e={used:this._used,peak:this._peak,total:this._total,byType:this._byType,string:[],system:[],user:[]};for(const[t,n]of this._strings.entries()){const i=ue(t);e.string.push({references:n,string:t,size:i,total:i+Qe})}for(const{container:t,total:n,type:i,calls:a}of this.enumContainersAllocations()){const o={container:{class:"<unknown>"},total:n,calls:a},c=t.deref();c!==void 0&&(o.container.class=c.constructor.name),i===A?e.system.push(o):e.user.push(o)}return e}addValueRef(e){const t=G(e)[0];u(typeof t=="string");const n=this.addStringRef(t);u(n),u(n.value!==1,"addValueRef must not be used to create a new string ref")}releaseValue(e){const t=G(e)[0];return u(typeof t=="string"),this.releaseString(t)}}const Me=s=>{if(s.type===r.array)return s.array;if(s.type===r.dictionary)return s.dictionary;u(!1,"Invalid value type")};class j{static size={integers:1};_refCount;static tracker={addValueRef(e){Me(e).addRef()},releaseValue(e){return Me(e).release()}};constructor(){this._refCount=1}get refCount(){return this._refCount}addRef(){++this._refCount}release(){const e=--this._refCount;return e===0?(this._dispose(),!1):(u(e>0,"Superfluous release"),!0)}}class ce extends j{_memoryTracker;_memoryType;_initialCapacity;_capacityIncrement;_toValue({isReadOnly:e,isExecutable:t}){return{type:r.array,isReadOnly:e,isExecutable:t,tracker:j.tracker,array:this}}toValue({isReadOnly:e=!0,isExecutable:t=!1}={}){return u(e&&!t,"Unsupported permissions"),this._toValue({isReadOnly:e,isExecutable:t})}_pointers=[];_values=[];constructor(e,t,n,i=1){super(),this._memoryTracker=e,this._memoryType=t,this._initialCapacity=n,this._capacityIncrement=i,u(this._initialCapacity>0),u(this._capacityIncrement>=0);const a=this._memoryTracker.allocate(ce.getSize(this._initialCapacity),this._memoryType,this);u(a),this._pointers.push(a.value)}static createInstance(e,t,n,i){u(n>0),u(i>=0);const a=e.isAvailable(this.getSize(n),t);if(!a.success)return a;const o=this;return{success:!0,value:new o(e,t,n,i)}}static getSize(e){return ne(j.size,{pointers:1,values:e})}getIncrementSize(e){return{pointers:1,values:e}}get memoryTracker(){return this._memoryTracker}get memoryType(){return this._memoryType}get length(){return this._values.length}at(e){return this._values[e]??h}get capacity(){return this._initialCapacity+(this._pointers.length-1)*this._capacityIncrement}increaseCapacityIfNeeded(e){const t=e-this.capacity;if(t>0){if(this._capacityIncrement===0)return{success:!1,exception:"limitcheck"};let n=Math.ceil(t/this._capacityIncrement);for(;n>0;){const i=this._memoryTracker.allocate(this.getIncrementSize(this._capacityIncrement),this._memoryType,this);if(!i.success)return i;this._pointers.push(i.value),--n}}return{success:!0,value:void 0}}_push(e){var t;for(const n of e)(t=n.tracker)==null||t.addValueRef(n),this.pushImpl(n)}push(...e){const t=this.increaseCapacityIfNeeded(this._values.length+e.length);return t.success?(this._push(e),{success:!0,value:this._values.length}):t}reduceCapacityIfNeeded(e=this._values.length){for(;this._pointers.length>1&&this.capacity-this._capacityIncrement>=e;){const t=this._pointers.at(-1);this._pointers.pop(),this._memoryTracker.release(t,this)}}_pop(){var t;let e=this.popImpl();return e.type!==r.null&&((t=e.tracker)==null?void 0:t.releaseValue(e))===!1&&(e=h),e}pop(){const e=this._pop();return this.reduceCapacityIfNeeded(),e}popush(e,t,...n){const{capacity:i}=this;let a;Array.isArray(t)?a=[...t,...n]:t?a=[t,...n]:a=[];const o=this.length-e+a.length;if(o>i){const c=this.increaseCapacityIfNeeded(o);if(!c.success)return c}for(;e>0;)this._pop(),--e;return this._push(a),this.reduceCapacityIfNeeded(),{success:!0,value:this.length}}clear(){for(;this.length>0;)this._pop();this.reduceCapacityIfNeeded()}_dispose(){this.clear(),this._memoryTracker.release(this._pointers[0],this)}}class Oe extends ce{static create(e,t,n,i){return super.createInstance(e,t,n,i)}get top(){const e=this._values[0];return e===void 0?h:e}pushImpl(e){this._values.unshift(e)}popImpl(){const e=this.at(0);return this._values.shift(),e}}l({name:"aload",description:"loads all items of the array in the operand stack",labels:["array"],signature:{input:[{type:r.array}]},samples:[{in:"[ 1 2 3 ] aload pop",out:"1 2 3"}]},({operands:s},e)=>{const{array:t}=e;return s.popush(1,[...ye(t)],e)});class be extends ce{static create(e,t,n,i){return super.createInstance(e,t,n,i)}toValue({isReadOnly:e=!0,isExecutable:t=!1}={}){return u(e||!t,"Unsupported permissions"),this._toValue({isReadOnly:e,isExecutable:t})}pushImpl(e){return this._values.push(e),{success:!0,value:void 0}}popImpl(){const e=this._values.at(-1)??h;return this._values.pop(),e}set(e,t){var a,o;if(e<0)return{success:!1,exception:"rangeCheck"};let n=this._values[e]??h;((a=n.tracker)==null?void 0:a.releaseValue(n))===!1&&(n=h);const i=this.increaseCapacityIfNeeded(e+1);return i.success?((o=t.tracker)==null||o.addValueRef(t),this._values[e]=t,{success:!0,value:n}):i}}function Re({operands:s,calls:e}){return e.top.debugSource?s.push(Object.assign({debugSource:e.top.debugSource},ge)):s.push(ge)}function et({operands:s,popCount:e,value:t,mark:n,closeOp:i}){return n.debugSource&&i.debugSource?s.popush(e,Object.assign({debugSource:{...n.debugSource,length:i.debugSource.pos-n.debugSource.pos+i.debugSource.length}},t)):s.popush(e,t)}const Ne="markpos",Pe="array",J=1,pe=2;function tt(s,{isExecutable:e}){const{operands:t,memoryTracker:n,calls:i}=s,{top:a}=i;if(i.topOperatorState===m){const y=ae(t);if(!y.success)return y;const D=y.value,X=v(D);u(X);const Ee=i.def(Ne,X.value);return Ee.success&&(i.topOperatorState=J),Ee}const o=i.lookup(Ne);u(o.type===r.integer);const c=o.integer;if(i.topOperatorState===J){const y=be.create(n,Ke,Math.max(c,1),1);if(!y.success)return y;const D=y.value,X=i.def(Pe,D.toValue({isReadOnly:e,isExecutable:e}));return X.success?i.topOperatorState=pe:D.release(),X}const p=i.lookup(Pe);u(p.type===r.array);const d=p.array;u(d instanceof be);const f=i.topOperatorState-pe;if(f<c){i.topOperatorState=pe+f+1;const y=d.set(c-f-1,t.at(f));return y.success||(d.release(),i.topOperatorState=J),y}const g=t.at(f),w=et({operands:t,popCount:1+c,value:p,mark:g,closeOp:a});return i.topOperatorState=w.success?M:J,d.release(),w}l({name:"]",description:"finalizes an array",labels:["array","mark"],signature:{output:[{type:r.array,permissions:{isReadOnly:!1,isExecutable:!1}}]},samples:[{description:"builds an array and check length and type",in:"[ 1 2 3 ] dup length exch type",out:"3 /array"},{description:"allocates an empty array",in:"[] dup length exch type",out:"0 /array"},{description:"fails if the corresponding array start does not exist",in:" 1 2 3 ]",out:"1 2 3 unmatchedmark"}]},s=>tt(s,{isExecutable:!1}));l({name:"[",description:"marks the beginning of an array",labels:["array","mark"],signature:{output:[{type:r.mark}]},samples:[{description:"builds an array and check length and type",in:"[ 1 2 3 ] dup length exch type",out:"3 /array"}]},Re);l({name:"and",description:"combines two booleans with and",labels:["boolean"],signature:{input:[{type:r.boolean},{type:r.boolean}],output:[{type:r.boolean}]},samples:[{in:"false false and",out:"false"},{in:"false true and",out:"false"},{in:"true false and",out:"false"},{in:"true true and",out:"true"}]},({operands:s},{isSet:e},{isSet:t})=>s.popush(2,x(e&&t)));l({name:"or",description:"combines two booleans with or",labels:["boolean"],signature:{input:[{type:r.boolean},{type:r.boolean}],output:[{type:r.boolean}]},samples:[{in:"false false or",out:"false"},{in:"false true or",out:"true"},{in:"true false or",out:"true"},{in:"true true or",out:"true"}]},({operands:s},{isSet:e},{isSet:t})=>s.popush(2,x(e||t)));l({name:"xor",description:"combines two booleans with exclusive or",labels:["boolean"],signature:{input:[{type:r.boolean},{type:r.boolean}],output:[{type:r.boolean}]},samples:[{in:"false false xor",out:"false"},{in:"false true xor",out:"true"},{in:"true false xor",out:"true"},{in:"true true xor",out:"false"}]},({operands:s},{isSet:e},{isSet:t})=>s.popush(2,x(e&&!t||!e&&t)));class L extends j{_memoryTracker;_memoryType;_initialCapacity;toValue({isReadOnly:e=!0,isExecutable:t}={}){return u(t!==!0,"Unsupported permissions"),{type:r.dictionary,isReadOnly:e,isExecutable:!1,tracker:j.tracker,dictionary:this}}_pointer;_slots={};constructor(e,t,n){super(),this._memoryTracker=e,this._memoryType=t,this._initialCapacity=n;const i=this._memoryTracker.allocate(L.getSize(this._initialCapacity),this._memoryType,this);u(i),this._pointer=i.value}static getSize(e){return ne(j.size,{pointers:1+2*e,values:e})}static create(e,t,n){const i=e.isAvailable(L.getSize(n),t);return i.success?{success:!0,value:new L(e,t,n)}:i}get names(){return Object.keys(this._slots)}lookup(e){var t;return((t=this._slots[e])==null?void 0:t.value)??h}_checkInitialCapacityUsage(){let e=0;for(const t of Object.values(this._slots))t.pointer===this._pointer&&++e;return e}_getNewValueSlot(e){const t=this._memoryTracker.addStringRef(e);if(!t.success)return t;if(this._checkInitialCapacityUsage()<this._initialCapacity)return{success:!0,value:{value:h,pointer:this._pointer}};const n=this._memoryTracker.allocate({values:1,pointers:3},this._memoryType,this);return n.success?{success:!0,value:{value:h,pointer:n.value}}:(this._memoryTracker.releaseString(e),n)}def(e,t){var a,o;let n=this._slots[e],i=(n==null?void 0:n.value)??h;if(n!==void 0){if(((a=i.tracker)==null?void 0:a.releaseValue(i))===!1&&(i=h),t.type===r.null)return n.pointer!==this._pointer&&this._memoryTracker.release(n.pointer,this),this._memoryTracker.releaseString(e),delete this._slots[e],{success:!0,value:i}}else if(t.type!==r.null){const c=this._getNewValueSlot(e);if(!c.success)return c;n=c.value}return u(n!==void 0),n.value=t,(o=t.tracker)==null||o.addValueRef(t),this._slots[e]=n,{success:!0,value:i}}_dispose(){var e;for(const[t,n]of Object.entries(this._slots))this._memoryTracker.releaseString(t),(e=n.value.tracker)==null||e.releaseValue(n.value),n.pointer!==this._pointer&&this._memoryTracker.release(n.pointer,this);this._memoryTracker.release(this._pointer,this)}}l({name:">>",aliases:["»","dicttomark"],description:"finalizes a dictionary",labels:["dictionary","mark"],signature:{output:[{type:r.dictionary,permissions:{isExecutable:!1,isReadOnly:!1}}]},samples:[{description:"builds a dictionary check length and type",in:"<< /test 123 >> dup length exch type",out:"1 /dictionary"},{description:"builds a dictionary check length and type",in:"« /test 123 » dup length exch type",out:"1 /dictionary"},{description:"builds a read/write dictionary",in:"« /test 123 » wcheck",out:"true"},{description:"builds a dictionary check length and type",in:"mark /test 123 dicttomark dup length exch type",out:"1 /dictionary"},{description:"builds a dictionary with shared values, check length and type",in:"<< /test 123 /test_array [ ] /test_dictionary << >> >> dup length exch type",out:"3 /dictionary"},{description:"allocates an empty dictionary",in:"<<>> dup length exch type",out:"0 /dictionary"},{description:"fails if the corresponding dictionary start does not exist",in:"/test 123 >>",out:"/test 123 unmatchedmark"},{description:"fails if the dictionary definition is invalid (names must be strings)",in:"<< 123 /test >>",out:"mark 123 /test typecheck"},{description:"fails if the dictionary definition is invalid (missing name value pair)",in:"<< /test 123 /missing_value >>",out:"mark 123 /test /missing_value typecheck"}]},s=>{const{operands:e,memoryTracker:t,calls:n}=s,i=ae(e);if(!i.success)return i;const a=i.value;if(a%2!==0)return{success:!1,exception:"typeCheck"};for(let f=1;f<a;f+=2)if(e.at(f).type!==r.name)return{success:!1,exception:"typeCheck"};const{top:o}=n,c=L.create(t,Ke,a/2);if(!c.success)return c;const p=c.value;for(let f=0;f<a;f+=2){const g=e.at(f),w=e.at(f+1),[y]=G(w),D=p.def(y,g);if(!D.success)return D}const d=et({operands:e,popCount:a+1,value:p.toValue({isReadOnly:!1}),mark:e.at(a),closeOp:o});return p.release(),d});l({name:"<<",aliases:["«"],description:"marks the beginning of a dictionary",labels:["dictionary","mark"],signature:{output:[{type:r.mark}]},samples:[{description:"builds a dictionary check length and type",in:"<< /test 123 >> dup length exch type",out:"1 /dictionary"},{description:"builds a dictionary check length and type",in:"« /test 123 » dup length exch type",out:"1 /dictionary"}]},s=>Re(s));l({name:"dictstackunderflow",description:"throws the exception : No custom dictionary left to unstack",labels:["exception"],signature:{exceptions:["dictstackunderflow"]},samples:[{in:"dictstackunderflow",out:"dictstackunderflow"}]},()=>({success:!1,exception:"dictStackUnderflow"}));l({name:"invalidaccess",description:"throws the exception : Object is read-only",labels:["exception"],signature:{exceptions:["invalidaccess"]},samples:[{in:"invalidaccess",out:"invalidaccess"}]},()=>({success:!1,exception:"invalidAccess"}));l({name:"limitcheck",description:"throws the exception : An implementation limit has been exceeded",labels:["exception"],signature:{exceptions:["limitcheck"]},samples:[{in:"limitcheck",out:"limitcheck"}]},()=>({success:!1,exception:"limitcheck"}));l({name:"rangecheck",description:"throws the exception : Operand is too big or too small",labels:["exception"],signature:{exceptions:["rangecheck"]},samples:[{in:"rangecheck",out:"rangecheck"}]},()=>({success:!1,exception:"rangeCheck"}));l({name:"stackunderflow",description:"throws the exception : Not enough operands on the stack to perform the operation",labels:["exception"],signature:{exceptions:["stackunderflow"]},samples:[{in:"stackunderflow",out:"stackunderflow"}]},()=>({success:!1,exception:"stackUnderflow"}));l({name:"stop",description:"throws the exception : Execution stopped",labels:["exception"],signature:{exceptions:["stop"]},samples:[{in:"stop",out:"stop"}]},()=>({success:!1,exception:"stop"}));l({name:"typecheck",description:"throws the exception : Operand is of the wrong type",labels:["exception"],signature:{exceptions:["typecheck"]},samples:[{in:"typecheck",out:"typecheck"}]},()=>({success:!1,exception:"typeCheck"}));l({name:"undefined",description:"throws the exception : Name is not defined in the dictionary stack",labels:["exception"],signature:{exceptions:["undefined"]},samples:[{in:"undefined",out:"undefined"}]},()=>({success:!1,exception:"undefined"}));l({name:"undefinedresult",description:"throws the exception : Result cannot be represented as a number",labels:["exception"],signature:{exceptions:["undefinedresult"]},samples:[{in:"undefinedresult",out:"undefinedresult"}]},()=>({success:!1,exception:"undefinedResult"}));l({name:"unmatchedmark",description:"throws the exception : Unmatched mark in the operand stack",labels:["exception"],signature:{exceptions:["unmatchedmark"]},samples:[{in:"unmatchedmark",out:"unmatchedmark"}]},()=>({success:!1,exception:"unmatchedMark"}));l({name:"vmoverflow",description:"throws the exception : Virtual memory exceeded",labels:["exception"],signature:{exceptions:["vmoverflow"]},samples:[{in:"vmoverflow",out:"vmoverflow"}]},()=>({success:!1,exception:"vmOverflow"}));l({name:"}",description:"finalizes a block",labels:["flow","mark"],signature:{output:[{type:r.array,permissions:{isExecutable:!0,isReadOnly:!0}}]},samples:[{description:"builds a block and check length and type",in:"{ 1 2 3 } dup length exch type",out:"3 /array"},{description:"allocated an empty block",in:"{} dup length exch type",out:"0 /array"},{description:"fails if the corresponding block start does not exist",in:"1 2 3 }",out:"1 2 3 unmatchedmark"}]},s=>(s.calls.topOperatorState===m&&s.allowCall(),tt(s,{isExecutable:!0})));const Dt="Invalid operator state change";class K extends Oe{static create(e,t,n,i){return u(t===A),super.createInstance(e,t,n,i)}_dictionaries=[];_steps=[];static getSize(e){return ne(super.getSize(e),{integers:e,pointers:e})}getIncrementSize(e){return ne(super.getIncrementSize(e),{integers:e,pointers:e})}pushImpl(e){super.pushImpl(e),this._dictionaries.unshift(void 0),this._steps.unshift(I)}popImpl(){const e=super.popImpl(),t=this._dictionaries[0];return t!==void 0&&t.release(),this._dictionaries.shift(),this._steps.shift(),e}snapshot(){const e=K.create(this.memoryTracker,this.memoryType,this.length,0);if(!e.success)return e;const t=e.value;let n=this.length;for(;--n>=0;)t.push(this.at(n)),t._steps[0]=this.operatorStateAt(n);return{success:!0,value:t}}operatorStateAt(e){return this._steps[e]??I}get names(){return[]}lookup(e){const t=this._dictionaries[0];return t===void 0?h:t.lookup(e)}def(e,t){if(this.length===0)return{success:!1,exception:"stackUnderflow"};let n=this._dictionaries[0];if(n===void 0){const i=L.create(this.memoryTracker,A,1);if(!i.success)return i;n=i.value,this._dictionaries[0]=n}return n.def(e,t)}get topOperatorState(){return u(this.length>0),this._steps[0]}set topOperatorState(e){const t=this.topOperatorState;(t===I&&e!==m||t!==I&&e===m||e===I||t===M||e!==M&&(t>m&&e<S||t<S&&e>=S||t===S&&e>m||t===m&&e<S))&&u(!1,Dt),this._steps[0]=e}}const st="block",nt="exception",it="stack",rt=-2;function $t(s,e,t){const{operands:n,calls:i}=s,a=i.def(st,t);if(!a.success)return a;i.topOperatorState=S;const o=i.push(e);if(o.success){const c=n.popush(2);u(c)}return o}function Vt(s){const{calls:e}=s;if(e.topOperatorState=rt,s.exception){const n=e.def(nt,Y(s.exception));if(!n.success)return n;u(s.exceptionStack instanceof K);const i=e.def(it,s.exceptionStack.toValue());if(!i.success)return i;s.clearException()}const t=e.lookup(st);return u(t.type!==r.null),e.push(t)}function Ht(s){const{calls:e}=s;if(s.exception===void 0){const t=e.lookup(nt);if(t!==h){u(t.type===r.string);const n=e.lookup(it);u(n.type===r.array),s.raiseException(t.string,n.array)}}return e.topOperatorState=M,{success:!0,value:void 0}}l({name:"finally",description:"executes the final block whenever the command block is unstacked",labels:["flow"],signature:{input:[{type:r.array,permissions:{isExecutable:!0}},{type:r.array,permissions:{isExecutable:!0}}]},samples:[{description:"always executes the final block",in:"{ 1 2 } { 3 } finally",out:"1 2 3"},{description:"does not prevent exception but enables post processing",in:"{ 1 undefined 2 } { 3 } finally",out:"1 3 undefined"},{description:"throws the last error",in:"{ 1 stackunderflow 2 } { 3 undefined 4 } finally",out:"1 3 undefined"},{description:"fails on no code block",in:"[ 1 2 ] { 3 } finally",out:"[ 1 2 ] { 3 } typecheck"}]},(s,e,t)=>{const{topOperatorState:n}=s.calls;return n===m?$t(s,e,t):n===S?Vt(s):(u(n===rt),Ht(s))});l({name:"if",description:"executes the operand based on a condition",labels:["flow"],signature:{input:[{type:r.boolean},{type:r.null}]},samples:[{in:"mark true { 123 } if",out:"mark 123"},{in:"mark false { 123 } if",out:"mark"},{description:"supports operand that is not a block",in:"mark true 123 if",out:"mark 123"}]},({operands:s,calls:e},{isSet:t},n)=>(s.popush(2),t?e.push(n):{success:!0,value:void 0}));l({name:"ifelse",description:"executes the operands based on a condition",labels:["flow"],signature:{input:[{type:r.boolean},{type:r.null},{type:r.null}]},samples:[{in:"mark true { 123 } { 456 } ifelse",out:"mark 123"},{in:"mark false { 123 } { 456 } ifelse",out:"mark 456"},{description:"supports operands that are not blocks",in:"mark true 123 456 ifelse",out:"mark 123"}]},({operands:s,calls:e},{isSet:t},n,i)=>(s.popush(3),t?e.push(n):e.push(i)));const Le="block";l({name:"loop",description:"repeatedly executes proc until proc executes the stop operator",labels:["flow","loop"],signature:{input:[{type:r.array,permissions:{isExecutable:!0}}]},samples:[{description:"executes the block until stop",in:"{ 1 count 3 eq { stop } if } loop",out:"1 1 1"},{description:"does not catch errors",in:"{ 1 typecheck } loop",out:"1 typecheck"},{description:"fails on no code block",in:"[ 1 2 ] loop",out:"[ 1 2 ] typecheck"}]},(s,e)=>{const{operands:t,calls:n}=s,{topOperatorState:i}=n;if(i===m)return n.topOperatorState=S,n.def(Le,e),t.pop(),n.push(e);if(u(i===S),s.exception)return s.exception==="stop"&&s.clearException(),n.topOperatorState=M,{success:!0,value:void 0};const a=n.lookup(Le);return n.push(a)});l({name:"{",description:"marks the beginning of a block",labels:["flow","mark"],samples:[{description:"builds a block and check length and type",in:"{ 1 2 3 } dup length exch type",out:"3 /array"}]},s=>{const e=Re(s);return e.success&&s.preventCall(),e});l({name:"stopped",description:"executes the value. If execution was interrupted with stop, return true, return false otherwise",labels:["flow"],signature:{input:[{type:r.null}]},samples:[{in:"{ 1 2 3 } stopped",out:"1 2 3 false"},{in:"{ 1 2 stop 3 } stopped",out:"1 2 true"},{in:"{ 1 2 typecheck 3 } stopped",out:"1 2 typecheck"}]},(s,e)=>{const{operands:t,calls:n}=s,{topOperatorState:i}=n;if(i===m){n.topOperatorState=S;const a=n.push(e);return a.success&&t.pop(),a}return u(i===S),n.topOperatorState=M,s.exception?s.exception==="stop"?(s.clearException(),t.push(x(!0))):{success:!0,value:void 0}:t.push(x(!1))});l({name:"abs",description:"returns absolute values of an integer",labels:["integer","math"],signature:{input:[{type:r.integer}],output:[{type:r.integer}]},samples:[{in:"1 abs",out:"1"},{in:"-1 abs",out:"1"}]},(s,{integer:e})=>{const{operands:t}=s;if(e<0){const n=v(-e);return n.success?t.popush(1,n.value):n}return{success:!0,value:void 0}});l({name:"add",description:"adds two integers",labels:["integer","math"],signature:{input:[{type:r.integer},{type:r.integer}],output:[{type:r.integer}]},samples:[{in:"1 2 add",out:"3"}]},(s,{integer:e},{integer:t})=>{const{operands:n}=s,i=v(e+t);return i.success?n.popush(2,i.value):i});l({name:"div",description:"realizes an euclidean division with two integers",labels:["integer","math"],signature:{input:[{type:r.integer},{type:r.integer}],output:[{type:r.integer},{type:r.integer}]},samples:[{in:"5 3 div",out:"1 2"},{in:"5 0 div",out:"undefinedresult"}]},(s,{integer:e},{integer:t})=>{const{operands:n}=s;if(t===0)return{success:!1,exception:"undefinedResult"};const i=e%t,a=v(i);if(!a.success)return a;const o=v((e-i)/t);return o.success?n.popush(2,o.value,a.value):o});l({name:"gt",description:"compares two integers to see if greater than",labels:["integer","math","comparison"],signature:{input:[{type:r.integer},{type:r.integer}],output:[{type:r.boolean}]},samples:[{in:"1 2 gt",out:"false"},{in:"2 1 gt",out:"true"}]},({operands:s},{integer:e},{integer:t})=>s.popush(2,x(e>t)));l({name:"gte",description:"compares two integers to see if greater than or equal",labels:["integer","math","comparison"],signature:{input:[{type:r.integer},{type:r.integer}],output:[{type:r.boolean}]},samples:[{in:"1 2 gte",out:"false"},{in:"2 1 gte",out:"true"},{in:"1 1 gte",out:"true"}]},({operands:s},{integer:e},{integer:t})=>s.popush(2,x(e>=t)));l({name:"lt",description:"compares two integers to see if lower than",labels:["integer","math","comparison"],signature:{input:[{type:r.integer},{type:r.integer}],output:[{type:r.boolean}]},samples:[{in:"1 2 lt",out:"true"},{in:"2 1 lt",out:"false"}]},({operands:s},{integer:e},{integer:t})=>s.popush(2,x(e<t)));l({name:"lte",description:"compares two integers to see if lower than or equal",labels:["integer","math","comparison"],signature:{input:[{type:r.integer},{type:r.integer}],output:[{type:r.boolean}]},samples:[{in:"1 2 lte",out:"true"},{in:"2 1 lte",out:"false"},{in:"1 1 lte",out:"true"}]},({operands:s},{integer:e},{integer:t})=>s.popush(2,x(e<=t)));l({name:"mul",description:"multiplies two integers",labels:["integer","math"],signature:{input:[{type:r.integer},{type:r.integer}],output:[{type:r.boolean}]},samples:[{in:"3 4 mul",out:"12"}]},(s,{integer:e},{integer:t})=>{const{operands:n}=s,i=v(e*t);return i.success?n.popush(2,i.value):i});l({name:"sub",description:"subtracts two integers",labels:["integer","math"],signature:{input:[{type:r.integer},{type:r.integer}],output:[{type:r.boolean}]},samples:[{in:"1 2 sub",out:"-1"}]},(s,{integer:e},{integer:t})=>{const{operands:n}=s,i=v(e-t);return i.success?n.popush(2,i.value):i});l({name:"countexecstack",description:"retrieves the number of dictionaries in the dictionary stack",labels:["callstack"],signature:{output:[{type:r.integer}]},samples:[{in:"countexecstack",out:"3"}]},({operands:s,calls:e})=>{const t=v(e.length);return u(t),s.push(t.value)});l({name:"begin",description:"pushes the dictionary on the dictionary stack, making it the current one",labels:["dictstack"],signature:{input:[{type:r.dictionary}]},samples:[{in:"<< /test 1 >> begin test end",out:"1"}]},({operands:s,dictionaries:e},t)=>{const n=e.push(t);return n.success&&s.pop(),n});const Bt=l({name:"pop",description:"removes the top item of the operand stack",labels:["operand"],signature:{input:[{type:r.null}]},samples:[{in:"1 2 3 pop",out:"1 2"}]},({operands:s})=>s.pop());function Ft(s,e,t,n){const{calls:i,dictionaries:a}=s,o=a.where(n);if(o!==null){const c=e.set(t,o.value);if(!c.success)return c}return i.topOperatorState=t+1,{success:!0,value:void 0}}function Ut(s,e,t,n){const{operands:i,calls:a}=s;a.topOperatorState=t+1;const o=i.push(n);if(!o.success)return o;const c=a.push(Bt);if(!c.success)return c;const p=a.push(qt);return p.success?{success:!0,value:void 0}:p}function zt(s,e,t){const{calls:n}=s,i=e.at(t);return i.isExecutable?i.type===r.name?Ft(s,e,t,i.name):(u(i.type===r.array),Ut(s,e,t,i)):(n.topOperatorState=t+1,{success:!0,value:void 0})}const qt=l({name:"bind",description:"binds the block calls to their value by resolving the names from the dictionary stack",labels:["dictstack","flow"],signature:{input:[{type:r.array,permissions:{isExecutable:!0}}],output:[{type:r.array,permissions:{isExecutable:!0}}]},samples:[{in:"{ clear } bind 0 get",out:"systemdict /clear get"},{description:"does not fail on unknown names",in:"{ clear test_unknown bind } bind 2 get",out:"systemdict /bind get"},{description:"works recursively",in:"{ clear { bind } } bind 1 get 0 get",out:"systemdict /bind get"},{description:"works only on code blocks",in:"[ 1 2 ] bind",out:"[ 1 2 ] typecheck"},{description:"does nothing when no names are used",in:"{ {} 1 2 3 } bind",out:"{ {} 1 2 3 }"},{description:"works on mixed content",in:"{ 1 clear } bind 1 get",out:"systemdict /clear get"}]},s=>{const{operands:e,calls:t}=s,{topOperatorState:n}=t,i=e.top;u(St(i));const{array:a}=i;return u(a instanceof be),n<a.length?zt(s,a,n):(t.topOperatorState=M,{success:!0,value:void 0})});l({name:"countdictstack",description:"retrieves the number of dictionaries in the dictionary stack",labels:["dictstack"],signature:{output:[{type:r.integer}]},samples:[{in:"countdictstack",out:"4"}]},({operands:s,dictionaries:e})=>{const t=v(e.length);return u(t.success),s.push(t.value)});l({name:"currentdict",description:"retrieves the top of the dictionary stack",labels:["dictstack"],signature:{output:[{type:r.dictionary}]},samples:[{in:"currentdict type",out:"/dictionary"}]},({operands:s,dictionaries:e})=>s.push(e.top));l({name:"def",description:"associates key with value in the current dictionary, the one on the top of the dictionary stack",labels:["dictstack"],signature:{input:[{type:r.name},{type:r.null}]},samples:[{in:"/test 1 def test",out:"/test 1 def 1"},{in:"systemdict begin /test 1 def test",out:"systemdict begin /test 1 invalidaccess"}]},({operands:s,dictionaries:e},{name:t},n)=>{if(e.top.isReadOnly)return{success:!1,exception:"invalidAccess"};const{dictionary:i}=e.top,a=i.def(t,n);return a.success?s.popush(2):a});l({name:"end",description:"pops the current dictionary off the dictionary stack, making the dictionary below it the current dictionary",labels:["dictstack"],samples:[{in:"<< /test 1 >> begin end test",out:"undefined"}]},({dictionaries:s})=>s.pop());l({name:"globaldict",description:"retrieves the global dictionary from the dictionary stack",labels:["dictstack"],signature:{output:[{type:r.dictionary}]},samples:[{in:"globaldict type",out:"/dictionary"}]},({operands:s,dictionaries:e})=>s.push(e.global));l({name:"systemdict",description:"retrieves the system dictionary from the dictionary stack",labels:["dictstack"],signature:{output:[{type:r.dictionary}]},samples:[{in:"systemdict type",out:"/dictionary"}]},({operands:s,dictionaries:e})=>s.push(e.system));l({name:"userdict",description:"retrieves the user dictionary from the dictionary stack",labels:["dictstack"],signature:{output:[{type:r.dictionary}]},samples:[{in:"userdict type",out:"/dictionary"}]},({operands:s,dictionaries:e})=>s.push(e.user));l({name:"clear",description:"clears the operand stack",labels:["operand"],samples:[{in:"1 2 3 clear",out:""}]},({operands:s})=>{for(;s.length>0;)s.pop()});l({name:"cleartomark",description:"clears the operand stack up to the first mark",labels:["operand","mark"],samples:[{in:"1 mark 2 3 cleartomark",out:"1"},{description:"fails if no mark is found",in:"1 2 3 cleartomark",out:"1 2 3 unmatchedmark"}]},({operands:s})=>{const e=ae(s);return e.success?s.popush(e.value+1):e});l({name:"count",description:"gives back the size of the operand stack",labels:["operand"],signature:{output:[{type:r.integer}]},samples:[{in:"1 2 3 count",out:"1 2 3 3"}]},({operands:s})=>{const e=v(s.length);return u(e.success),s.push(e.value)});l({name:"counttomark",description:"count the number of items in the operand stack up to the first mark",labels:["operand"],signature:{output:[{type:r.integer}]},samples:[{in:"1 mark 2 3 counttomark",out:"1 mark 2 3 2"},{description:"fails if no mark is found",in:"1 2 3 counttomark",out:"1 2 3 unmatchedmark"}]},({operands:s})=>{const e=ae(s);if(!e.success)return e;const t=v(e.value);return u(t.success),s.push(t.value)});l({name:"dup",description:"duplicates the top item of the operand stack",labels:["operand"],signature:{input:[{type:r.null}],output:[{type:r.null},{type:r.null}]},samples:[{in:"1 2 3 dup",out:"1 2 3 3"}]},({operands:s},e)=>s.push(e));l({name:"exch",description:"swaps the first two items of the operand stack",labels:["operand"],signature:{input:[{type:r.null},{type:r.null}],output:[{type:r.null},{type:r.null}]},samples:[{in:"1 2 3 exch",out:"1 3 2"}]},({operands:s},e,t)=>s.popush(2,t,e));l({name:"index",description:"duplicates the Nth item of the operand stack",labels:["operand"],signature:{input:[{type:r.integer}],output:[{type:r.null}]},samples:[{in:"1 2 3 1 index",out:"1 2 3 2"},{description:"throws stackunderflow if index is too big",in:"1 2 3 5 index",out:"1 2 3 5 stackunderflow"}]},({operands:s},{integer:e})=>e>s.length?{success:!1,exception:"stackUnderflow"}:s.popush(1,s.at(e+1)));l({name:"roll",description:"performs a circular shift of the values on the operand stack by a given amount",labels:["operand"],signature:{input:[{type:r.integer},{type:r.integer}]},samples:[{in:"100 200 300 3 -1 roll",out:"200 300 100"},{in:"100 200 300 3 1 roll",out:"300 100 200"},{in:"100 200 300 3 0 roll",out:"100 200 300"},{in:'"a" "b" "c" 3 2 roll',out:'"b" "c" "a"'},{description:"fails if the number of values to roll is invalid",in:"100 200 300 0 0 roll",out:"100 200 300 0 0 rangecheck"},{description:"fails if the number of values to roll is invalid",in:"100 200 300 -1 0 roll",out:"100 200 300 0 0 rangecheck"},{description:"fails if the number of values to roll is invalid",in:"100 200 300 4 0 roll",out:"100 200 300 0 0 rangecheck"},{description:"fails if the number of values to roll is invalid",in:"100 200 300 50 0 roll",out:"100 200 300 0 0 rangecheck"}]},({operands:s},{integer:e},{integer:t})=>{var i,a;if(e<=0||e>s.length-2)return{success:!1,exception:"rangeCheck"};if(s.pop(),s.pop(),t=-t%e,t===0)return;t<0&&(t+=e);const n=[];try{for(let o=e;o>0;--o){const c=s.top;n.unshift(c),(i=c.tracker)==null||i.addValueRef(c),s.pop()}for(let o=0;o<e;++o){const c=n[(o+t)%e];s.push(c)}}finally{for(const o of n)(a=o.tracker)==null||a.releaseValue(o)}return{success:!0,value:void 0}});l({name:"cvi",description:"converts to integer",labels:["value","generic","conversion"],signature:{input:[{type:r.null}],output:[{type:r.integer}]},samples:[{in:"1 cvi",out:"1"},{in:'"1" cvi',out:"1"},{description:"fails if number goes beyond limit",in:'"9007199254740992" cvi',out:"undefinedresult"},{in:"/1 cvi",out:"typecheck"},{in:"<< >> cvi",out:"typecheck"}]},({operands:s},e)=>{if(e.type!==r.integer)if(e.type===r.string){const t=Number.parseInt(e.string,10),n=v(t);return n.success?s.popush(1,n.value):n}else return{success:!1,exception:"typeCheck"};return{success:!0,value:void 0}});l({name:"cvlit",description:"removes executable flag",labels:["value","generic","conversion"],signature:{input:[{type:r.null}],output:[{type:r.null,permissions:{isExecutable:!1}}]},samples:[{in:"1 cvlit",out:"1"},{description:"converts a block to a read-only array",in:"{ 1 } cvlit dup xcheck exch wcheck",out:"false false"},{description:"converts a call to a name",in:"{ test } 0 get cvlit",out:"/test"}]},({operands:s},e)=>e.isExecutable?s.popush(1,{...e,isExecutable:!1}):{success:!0,value:void 0});l({name:"cvn",description:"converts to name",labels:["value","generic","conversion"],signature:{input:[{type:r.string}],output:[{type:r.name}]},samples:[{in:'"test" cvn',out:"/test"},{in:"/test cvn",out:"typecheck"},{in:"1 cvn",out:"typecheck"}]},({operands:s,memoryTracker:e},{string:t})=>{u(e instanceof F);const n=e.addStringRef(t);if(!n.success)return n;const i=s.popush(1,Ze(t,{tracker:e}));return e.releaseString(t),i});l({name:"eq",description:"compares two values and return true if they are strictly equal",labels:["generic","comparison"],signature:{input:[{type:r.null},{type:r.null}],output:[{type:r.boolean}]},samples:[{in:"1 1 eq",out:"true"},{in:"1 2 eq",out:"false"},{in:'1 "1" eq',out:"false"},{in:"[ ] [ ] eq",out:"false"},{in:"[ ] dup eq",out:"true"}]},({operands:s},e,t)=>{let n;if(e.type===t.type){const[i,a]=G(e,t);n=i===a}else n=!1;return s.popush(2,x(n))});oe({name:"false",description:"pushes false in the operand stack",labels:["value"],signature:{output:[{type:r.boolean}]},samples:[{in:"false type",out:"/boolean"}]},x(!1));const jt={[r.string]:({string:s,tracker:e},t)=>{u(e instanceof F);const n=se(t,s.length);if(!n.success)return n;const i=s.charAt(n.value),a=e.addStringRef(i);return a.success?{success:!0,value:Y(i,{tracker:e})}:a},[r.array]:({array:s},e)=>{var i;const t=se(e,s.length);if(!t.success)return t;const n=s.at(t.value);return(i=n.tracker)==null||i.addValueRef(n),{success:!0,value:n}},[r.dictionary]:({dictionary:s},e)=>{var i;if(e.type!==r.name)return{success:!1,exception:"typeCheck"};const{name:t}=e;if(!s.names.includes(t))return{success:!1,exception:"undefined"};const n=s.lookup(t);return(i=n.tracker)==null||i.addValueRef(n),{success:!0,value:n}}};l({name:"get",description:"returns an indexed item from the value",labels:["generic"],signature:{input:[{type:r.null},{type:r.null}],output:[{type:r.null}]},samples:[{description:"returns the Nth item of an array",in:"[ 1 2 3 ] 1 get",out:"2"},{description:"returns the Nth item of an executable array",in:"{ 1 2 3 } 1 get",out:"2"},{description:"fails if invalid index for the array",in:"[ 1 2 3 ] /a get",out:"[ 1 2 3 ] /a typecheck"},{description:"fails if out of bound index for the array",in:"[ 1 2 3 ] -1 get",out:"[ 1 2 3 ] -1 rangecheck"},{description:"fails if out of bound index for the array",in:"[ 1 2 3 ] 3 get",out:"[ 1 2 3 ] -1 rangecheck"},{description:"returns the Nth character of a string",in:'"abc" 1 get',out:'"b"'},{description:"fails if invalid index for a string",in:'"abc" "a" get',out:'"abc" "a" typecheck'},{description:"fails if out of bound index for a string",in:'"abc" -1 get',out:'"abc" -1 rangecheck'},{description:"fails if out of bound index for a string",in:'"abc" 3 get',out:'"abc" 3 rangecheck'},{description:"returns the indexed item of a dictionary",in:"systemdict /get get",out:"{ get } bind 0 get"},{description:"returns the indexed item of a dictionary (handles reference counting)",in:'/test "abc" def userdict /test get',out:'/test "abc" def "abc"'},{description:"fails if invalid index for a dictionary",in:"systemdict 0 get",out:"systemdict 0 typecheck"},{description:"fails if unknown index for a dictionary",in:"systemdict /not_an_operator get",out:"systemdict /not_an_operator undefined"},{description:"fails if not a container",in:"1 1 get",out:"1 1 typecheck"},{description:"fails if not a container",in:"false 1 get",out:"false 1 typecheck"},{description:"fails if not a container",in:"mark 1 get",out:"mark 1 typecheck"}]},({operands:s},e,t)=>{var c;const n=jt[e.type];if(n===void 0)return{success:!1,exception:"typeCheck"};const i=n(e,t);if(!i.success)return i;const{value:a}=i,o=s.popush(2,a);return(c=a.tracker)==null||c.releaseValue(a),o});const Yt={[r.string]:({string:s})=>s.length,[r.array]:({array:s})=>s.length,[r.dictionary]:({dictionary:s})=>s.names.length};l({name:"length",description:"returns the length of the value",labels:["generic"],signature:{input:[{type:r.null}],output:[{type:r.integer}]},samples:[{description:"returns the number of items in an array",in:"[ 1 2 3 ] length",out:"3"},{description:"returns the number of items in an executable array",in:"{ 1 2 3 } length",out:"3"},{description:"returns the size of a string",in:'"abc" length',out:"3"},{description:"returns the number of keys in a dictionary",in:"systemdict length 0 gt",out:"true"},{description:"fails if not a container",in:"1 length",out:"1 typecheck"},{description:"fails if not a container",in:"false length",out:"false typecheck"},{description:"fails if not a container",in:"mark length",out:"mark typecheck"}]},({operands:s},e)=>{const t=Yt[e.type];if(t===void 0)return{success:!1,exception:"typeCheck"};const n=v(t(e));return u(n.success),s.popush(1,n.value)});oe({name:"mark",description:"pushes a mark in the operand stack",labels:["value","mark"],signature:{output:[{type:r.mark}]},samples:[{in:"1 2 mark",out:"1 2 mark"},{description:"marks part of the stack for operations",in:"1 2 mark 3 4 5 cleartomark",out:"1 2"}]},ge);l({name:"neq",description:"compares two values and return true if they are strictly different",labels:["generic","comparison"],signature:{input:[{type:r.null},{type:r.null}],output:[{type:r.boolean}]},samples:[{in:"1 1 neq",out:"false"},{in:"1 2 neq",out:"true"},{in:'1 "1" neq',out:"true"},{in:"[ ] [ ] neq",out:"true"},{in:"[ ] dup neq",out:"false"}]},({operands:s},e,t)=>{let n;if(e.type===t.type){const[i,a]=G(e,t);n=i!==a}else n=!0;return s.popush(2,x(n))});const Gt={[r.string]:({string:s,tracker:e},t,n)=>{if(u(e instanceof F),n.type!==r.integer)return{success:!1,exception:"typeCheck"};const{integer:i}=n;if(i<0||i>65535)return{success:!1,exception:"rangeCheck"};const a=se(t,s.length);if(!a.success)return a;const o=s.slice(0,Math.max(0,a.value))+String.fromCodePoint(i)+s.slice(Math.max(0,a.value+1)),c=e.addStringRef(o);return c.success?{success:!0,value:Y(o,{tracker:e})}:c},[r.array]:(s,e,t)=>{var c;const{array:n,isReadOnly:i}=s;if(i)return{success:!1,exception:"invalidAccess"};const a=se(e,n.length);if(!a.success)return a;const o=n.set(a.value,t);return o.success?((c=s.tracker)==null||c.addValueRef(s),{success:!0,value:s}):o},[r.dictionary]:(s,e,t)=>{var c;const{dictionary:n,isReadOnly:i}=s;if(i)return{success:!1,exception:"invalidAccess"};if(e.type!==r.name)return{success:!1,exception:"typeCheck"};const{name:a}=e,o=n.def(a,t);return o.success?((c=s.tracker)==null||c.addValueRef(s),{success:!0,value:s}):o}};l({name:"put",description:"sets an indexed item in the value",postScriptDeviation:"returns the modified object or a new string",labels:["generic"],signature:{input:[{type:r.null},{type:r.null},{type:r.null}],output:[{type:r.null}]},samples:[{description:"sets the Nth item of an array",in:"[ 1 2 3 ] 1 5 put",out:"[ 1 5 3 ]"},{description:"fails if the array is not writable",in:"{ 1 2 3 } 1 5 put",out:"{ 1 2 3 } 1 5 invalidaccess"},{description:"fails if invalid index for the array",in:'[ 1 2 3 ] "a" 5 put',out:'[ 1 2 3 ] "a" 5 typecheck'},{description:"fails if out of bound index for the array",in:"[ 1 2 3 ] -1 5 put",out:"[ 1 2 3 ] -1 5 rangecheck"},{description:"fails if out of bound index for the array",in:"[ 1 2 3 ] 3 5 put",out:"[ 1 2 3 ] 3 5 rangecheck"},{description:"sets the Nth character of a string (returns a new string, using ascii code)",in:'"abc" 1 66 put',out:'"aBc"'},{description:"fails if setting an invalid value",in:'"abc" 1 "B" put',out:'"abc" 1 "B" typecheck'},{description:"fails if setting an invalid value",in:'"abc" 1 -1 put',out:'"abc" 1 -1 rangecheck'},{description:"fails if setting an invalid value",in:'"abc" 1 65536 put',out:'"abc" 1 65536 rangecheck'},{description:"fails if invalid index for a string",in:'"abc" "a" 66 put',out:'"abc" "a" 66 typecheck'},{description:"fails if out of bound index for a string",in:'"abc" -1 66 put',out:'"abc" -1 66 rangecheck'},{description:"fails if out of bound index for a string",in:'"abc" 3 66 put',out:'"abc" 3 66 rangecheck'},{description:"sets an indexed item of a dictionary",in:"userdict /test 123 put pop test",out:"userdict /test 456 put pop 123"},{description:"fails if the dictionary is not writable",in:"systemdict /test 123 put",out:"systemdict /test 123 invalidaccess"},{description:"fails if invalid index for a dictionary",in:"userdict 0 123 put",out:"userdict 0 123 typecheck"},{description:"fails if not a container",in:"1 0 1 put",out:"1 0 1 typecheck"},{description:"fails if not a container",in:"false 0 1 put",out:"false 0 1 typecheck"},{description:"fails if not a container",in:"mark 0 1 put",out:"mark 0 1 typecheck"}]},({operands:s},e,t,n)=>{var p;const i=Gt[e.type];if(i===void 0)return{success:!1,exception:"typeCheck"};const a=i(e,t,n);if(!a.success)return a;const{value:o}=a,c=s.popush(3,o);return(p=e.tracker)==null||p.releaseValue(o),c});oe({name:"true",description:"pushes true in the operand stack",labels:["value"],signature:{output:[{type:r.boolean}]},samples:[{in:"true type",out:"/boolean"}]},x(!0));l({name:"type",description:"pushes the type of the value in the operand stack",labels:["value","generic"],signature:{input:[{type:r.null}],output:[{type:r.name}]},samples:[{in:"false type",out:"/boolean"},{in:"[ 1 2 3 ] type",out:"/array"},{in:'"" type',out:"/string"},{in:"/type type",out:"/name"}]},({operands:s,memoryTracker:e},t)=>{u(e instanceof F);const{type:n}=t,i=e.addStringRef(n);if(!i.success)return i;const a=s.popush(1,Ze(n,{tracker:e}));return e.releaseString(n),a});const Xt="@psbots/engine@0.0.1";oe({name:"version",description:"returns a string that identifies the version of the engine",labels:["value"],signature:{output:[{type:r.string}]},samples:[{in:"version type",out:"/string"}]},Y(Xt));l({name:"wcheck",description:"checks if value is writable",labels:["value","generic","permission"],signature:{input:[{type:r.null}],output:[{type:r.boolean}]},samples:[{description:"returns false for blocks",in:"{ 1 2 } wcheck",out:"false"},{description:"returns true for arrays",in:"[ 1 2 ] wcheck",out:"true"}]},({operands:s},e)=>s.popush(1,x(!e.isReadOnly)));l({name:"xcheck",description:"checks if value is executable",labels:["value","generic","permission"],signature:{input:[{type:r.null}],output:[{type:r.boolean}]},samples:[{description:"returns true for blocks",in:"{ 1 2 } xcheck",out:"true"},{description:"returns false for arrays",in:"[ 1 2 ] xcheck",out:"false"}]},({operands:s},e)=>s.popush(1,x(e.isExecutable)));class we{constructor(){}static _instance;static get instance(){return this._instance??=new we,this._instance}get names(){return Object.keys(q)}lookup(e){const t=q[e];return t!==void 0?t.value:h}}class V{constructor(){}static _instance;static get instance(){return this._instance??=new V,this._instance}get names(){return[]}lookup(){return h}def(e,t){return u(!!e),u(!!t),{success:!1,exception:"invalidAccess"}}}const Z=4,De=-1,Wt=-2,de=-3,he=-4;class Kt extends Oe{static create(e,t,n,i){return u(t===A),u(n>4),super.createInstance(e,t,n,i)}constructor(e,t,n,i){super(e,t,n,i),this.begin({type:r.dictionary,isExecutable:!1,isReadOnly:!0,dictionary:V.instance}),this.begin({type:r.dictionary,isExecutable:!1,isReadOnly:!0,dictionary:we.instance}),this.begin({type:r.dictionary,isExecutable:!1,isReadOnly:!1,dictionary:V.instance}),this.begin({type:r.dictionary,isExecutable:!1,isReadOnly:!1,dictionary:V.instance})}getDictionaryValue(e){const t=this._values[this._values.length+e];return u(!!t&&t.type===r.dictionary),t}setHost(e){var t;this._values[Z+De]=e,(t=e.tracker)==null||t.addValueRef(e)}setGlobal(e){var n;const t=this.getDictionaryValue(de);u(t.dictionary===V.instance),this._values[Z+de]=e,(n=e.tracker)==null||n.addValueRef(e)}setUser(e){var n;const t=this.getDictionaryValue(he);u(t.dictionary===V.instance),this._values[Z+he]=e,(n=e.tracker)==null||n.addValueRef(e)}get top(){return super.top}get host(){return this.getDictionaryValue(De)}get system(){return this.getDictionaryValue(Wt)}get global(){return this.getDictionaryValue(de)}get user(){return this.getDictionaryValue(he)}begin(e){return this.push(e)}end(){return this.length===Z?{success:!1,exception:"dictStackUnderflow"}:(this.pop(),{success:!0,value:this.length})}where(e){for(const t of this._values){const{dictionary:n}=t,i=n.lookup(e);if(i.type!==r.null)return{dictionary:n,value:i}}return null}lookup(e){const t=this.where(e);return t===null?{success:!1,exception:"undefined"}:{success:!0,value:t.value}}}function at(s,e){const{calls:t}=s,n=e.operator;if(t.topOperatorState>=m||t.topOperatorState===M)t.pop();else{const i=n.implementation(s);i&&i.success===!1&&s.raiseException(i.exception)}}function Jt(s,e){var p;const{operands:t,memoryTracker:n}=s;u(n instanceof F),u(e.typeCheck!==void 0);let{length:i}=e.typeCheck;if(t.length<i){s.raiseException("stackUnderflow");return}const a=n.allocate({values:i},A,s);if(!a.success){s.raiseException(a.exception);return}const o=[],c=a.value;for(const{type:d,permissions:f}of e.typeCheck){const g=t.at(--i),{isReadOnly:w,isExecutable:y}=f??{};if((d===r.null||d===g.type)&&(w===void 0||w===g.isReadOnly)&&(y===void 0||y===g.isExecutable))o.push(g);else{s.raiseException("typeCheck"),n.release(c,s);return}}for(const d of o)(p=d.tracker)==null||p.addValueRef(d);return{valuesMemory:c,values:o}}function Zt(s,e){var f;const{calls:t,memoryTracker:n}=s;u(n instanceof F);const{top:i}=t,a=t.topOperatorState===I;a&&(t.topOperatorState=m);let o,c=[];if(e.typeCheck!==void 0&&a){const g=Jt(s,e);if(g===void 0)return;o=g.valuesMemory,c=g.values}const p=s.exception,d=e.implementation(s,...c);if(o!==void 0){for(const g of c)(f=g.tracker)==null||f.releaseValue(g);n.release(o,s)}d&&d.success===!1&&s.raiseException(d.exception),s.exception===p&&t.length>0&&t.top===i&&(t.topOperatorState===M||t.topOperatorState===m)&&t.pop()}function Qt(s,e){const{operands:t,calls:n}=s;if(n.topOperatorState<=m){at(s,e);return}const i=e.operator;i.type===B.constant?(t.push(i.constant),n.pop()):Zt(s,i)}function es(s,e){const{dictionaries:t,calls:n,callEnabled:i,operands:a}=s;if(n.topOperatorState===m)n.pop();else if(i||["{","}","<<","«",">>","»"].includes(e.name)){n.topOperatorState=m;const o=t.lookup(e.name);if(!o.success){s.raiseException(o.exception);return}const c=o.value;e.debugSource?n.push(Object.assign({debugSource:e.debugSource},c)):n.push(c)}else a.push(e),n.pop()}function ts({calls:s,operands:e},{array:t}){const{length:n}=t;if(s.topOperatorState===I?s.topOperatorState=m:s.topOperatorState++,s.topOperatorState===n)s.pop();else{const i=s.topOperatorState,a=t.at(i);!a.isExecutable||a.type===r.array?e.push(a):s.push(a)}}const ke="unknown";function ss(s,e){var n,i;const{calls:t}=s;if(t.topOperatorState===I){t.topOperatorState=m;const[a]=me(e.string,{pos:0,filename:((n=e.debugSource)==null?void 0:n.filename)??ke});return a}else{const[,a]=me(e.string,{pos:t.topOperatorState,filename:((i=e.debugSource)==null?void 0:i.filename)??ke});return a}}function ns(s,e){var p;const{calls:t,operands:n}=s,i=s.memoryTracker,{pos:a}=e.debugSource;if(a>0&&(t.topOperatorState=a),((p=e.debugSource)==null?void 0:p.filename)===ke){const{debugSource:d,...f}=e;e=f}let o;if(e.type===r.string||e.type===r.name){o=G(e)[0];const d=i.addStringRef(o);if(!d.success){s.raiseException(d.exception);return}Object.assign(e,{tracker:i})}const c=e.isExecutable?t.push(e):n.push(e);o!==void 0&&i.releaseString(o),c.success||s.raiseException(c.exception)}function is(s,e){const{calls:t}=s,n=ss(s,e);n?ns(s,n):t.pop()}let rs=class ot{_memoryTracker;_dictionaries;_operands;_calls;_exception;_exceptionStack;_destroyed=!1;constructor(e,t,n,i){this._memoryTracker=e,this._dictionaries=t,this._operands=n,this._calls=i}static create(e={}){const t=new F({total:e.maxMemoryBytes,debug:e.debugMemory}),n=Kt.create(t,A,10,1);if(!n.success)return n;const i=n.value;e.hostDictionary&&i.setHost({type:r.dictionary,isReadOnly:!0,isExecutable:!1,dictionary:e.hostDictionary});const a=L.create(t,A,10);if(!a.success)return a;i.setGlobal(a.value.toValue({isReadOnly:!1})),a.value.release();const o=L.create(t,A,10);if(!o.success)return o;i.setUser(o.value.toValue({isReadOnly:!1})),o.value.release();const c=Oe.create(t,A,10,5);if(!c.success)return c;const p=K.create(t,A,10,5);return p.success?{success:!0,value:new ot(t,i,c.value,p.value)}:p}get destroyed(){return this._destroyed}_checkIfDestroyed(){u(!this._destroyed,"State instance destroyed")}_resetException(){this._exception!==void 0&&(this._exception=void 0),this._exceptionStack!==void 0&&(this._exceptionStack.release(),this._exceptionStack=void 0)}get idle(){return this._checkIfDestroyed(),this._calls.length===0}get memoryTracker(){return this._memoryTracker}get operands(){return this._checkIfDestroyed(),this._operands}get dictionaries(){return this._checkIfDestroyed(),this._dictionaries}_callDisablingCount=0;get callEnabled(){return this._callDisablingCount===0}get exception(){return this._checkIfDestroyed(),this._exception}get exceptionStack(){return this._checkIfDestroyed(),this._exceptionStack}exec(e){return this._checkIfDestroyed(),this.idle?(this._resetException(),this.calls.push(e),{success:!0,value:this.run()}):{success:!1,exception:"invalidAccess"}}destroy(){this._checkIfDestroyed(),this._resetException(),this._calls.release(),this._operands.release(),this._dictionaries.release(),this._destroyed=!0;const{used:e}=this._memoryTracker;u(e===0,"Memory leaks detected")}raiseException(e,t){if(this._resetException(),this._exception=e,t!==void 0)u(t instanceof K),this._exceptionStack=t,this._exceptionStack.addRef();else if(e!=="vmOverflow"){const n=this._calls.snapshot();u(n),this._exceptionStack=n.value}}clearException(){this._resetException()}get calls(){return this._calls}allowCall(){++this._callDisablingCount}preventCall(){--this._callDisablingCount}*run(){for(;this.calls.length>0;)this.cycle(),yield}cycle(){const e=this._calls,{top:t}=e;this._exception?t.type===r.operator?at(this,t):e.pop():t.isExecutable?t.type===r.operator?Qt(this,t):t.type===r.name?es(this,t):t.type===r.array?ts(this,t):t.type===r.string?is(this,t):u(!1,"Unsupported executable value"):(this._operands.push(t),e.pop())}};function as(s){return rs.create(s)}const k=3200,b=2e3,$e=20,C=50,P=300,_=32,ct=500,ut=3;class os{_paddles=[{y:0,dy:0,score:0,running:!1},{y:0,dy:0,score:0,running:!1}];get paddles(){return this._paddles}_ball={x:0,dx:0,y:0,dy:0};get ball(){return this._ball}_lastParticleId=0;_particles=[];get particles(){return this._particles}addParticle(e){this._particles.push({...e,id:this._lastParticleId++})}resetPositions(){for(const t of this.paddles)t.y=Math.floor((b-P)/2),t.dy=0;const{ball:e}=this;e.x=Math.floor(k/2)-_,e.dx=0,e.y=Math.floor(b/2)-_,e.dy=0}reset(){this._lastParticleId=0,this.resetPositions();for(const e of this.paddles)e.score=0,e.running=!0;this._particles=[]}_runPaddles(){for(const e of this._paddles){const{dy:t}=e;let{y:n}=e;n+=t,t>0?n>b-P&&(n=b-P):n<0&&(n=0),e.y=n}}_runBall(){let{x:e,dx:t,y:n,dy:i}=this._ball;e+=t,n+=i,e>k-_-C&&n>this._paddles[1].y&&n<this._paddles[1].y+P?(t=-t,e=2*(k-_-C)-e):e>k-_?(++this._paddles[0].score,t=-t,e=2*(k-_)-e):e<_+C&&n>this._paddles[0].y&&n<this._paddles[0].y+P?(t=-t,e=2*(_+C)-e):e<_&&(++this._paddles[1].score,t=-t,e=2*_-e),n>b-_?(i=-i,n=2*(b-_)-n):n<_&&(i=-i,n=2*_-n),this._ball={x:e,dx:t,y:n,dy:i}}_runParticles(){let e=!1;for(const t of this._particles)t.x+=t.dx,t.y+=t.dy,e=e||0>--t.frames;e&&(this._particles=this._particles.filter(({frames:t})=>t>0))}run(){this._runPaddles(),this._runBall(),this._runParticles()}constructor(){this.reset()}}const cs="board_width",us="board_height",ls="paddle_width",ps="paddle_height",Ve="current_y",He="current_x",Be="opponent_y",Fe="opponent_x",Ue="ball_center_x",ze="ball_center_y",ds="ball_radius",qe="ball_speed_x",je="ball_speed_y",Ye="paddle_up",Ge="paddle_down",E=s=>{const e=v(s);return u(e),e.value},U=(s,e)=>({type:r.operator,isExecutable:!0,isReadOnly:!0,operator:{name:s,type:B.implementation,implementation:({operands:t})=>t.push(E(e()))}}),Xe=(s,e)=>({type:r.operator,isExecutable:!0,isReadOnly:!0,operator:{name:s,type:B.implementation,implementation:e}});class hs{constructor(e,t){this._state=e,this._paddleIndex=t,this._mappings[He]=this._paddleIndex===0?E(0):E(k-C),this._mappings[Ve]=U("HOST_CURRENT_Y",()=>this._state.paddles[this._paddleIndex].y),this._mappings[Fe]=this._paddleIndex===1?E(0):E(k-C),this._mappings[Be]=U("HOST_OPPONENT_Y",()=>this._state.paddles[1-this._paddleIndex].y),this._mappings[Ue]=U("HOST_BALL_CENTER_X",()=>this._state.ball.x),this._mappings[ze]=U("HOST_BALL_CENTER_Y",()=>this._state.ball.y),this._mappings[qe]=U("HOST_BALL_SPEED_X",()=>this._state.ball.dx),this._mappings[je]=U("HOST_BALL_SPEED_Y",()=>this._state.ball.dy),this._mappings[Ye]=Xe("HOST_PADDLE_UP",()=>{this._state.addParticle({x:this._paddleIndex===1?k-C:0,y:this._state.paddles[this._paddleIndex].y+P,dx:0,dy:0,frames:60,className:"paddle_action",content:"⬆"}),this._state.paddles[this._paddleIndex].dy=-1}),this._mappings[Ge]=Xe("HOST_PADDLE_DOWN",()=>{this._state.addParticle({x:this._paddleIndex===1?k-C:0,y:this._state.paddles[this._paddleIndex].y,dx:0,dy:0,frames:60,className:"paddle_action",content:"⬇"}),this._state.paddles[this._paddleIndex].dy=1})}_mappings={[cs]:E(k),[us]:E(b),[ls]:E(C),[ps]:E(P),[He]:h,[Ve]:h,[Fe]:h,[Be]:h,[Ue]:h,[ze]:h,[ds]:E(_),[qe]:h,[je]:h,[Ye]:h,[Ge]:h};get names(){return Object.keys(this._mappings)}lookup(e){return this._mappings[e]??h}}class fs{_state;get state(){return this._state}_engines=[];_allocateEngine(e){const t=as({hostDictionary:new hs(this._state,e)});u(t);const n=t.value;return this._engines[e]=n,n}_runners=[];_speed=1;get speed(){return this._speed}resetSpeed(){this._speed=1}increaseSpeed(){this._speed>10?this._speed=Math.min(this._speed+10,1e3):++this._speed}decreaseSpeed(){this._speed=this._speed>10?Math.max(this._speed-20,1):Math.max(this._speed-1,0)}_oneStep=!1;oneStep(){this._oneStep=!0}_maxPoints=ut;_ended=!1;setup({scripts:e,maxPoints:t}){this._maxPoints=t;for(let n=0;n<2;++n){const i=this._allocateEngine(n);Rt(i.exec(Y(e[n],{isExecutable:!0})));const a=i.exec(Y("main",{isExecutable:!0}));this._state.paddles[n].running=!0,u(a),this._runners[n]=a.value}this._state.ball.dx=1,this._state.ball.dy=1}_engineStopped(e){console.log(`${e?"Right":"Left"} paddle stopped running`);const t=this._engines[e],{exception:n}=t;if(n){console.log(`❌ ${n}`);const{exceptionStack:i}=t;if(i)for(const a of Ct(i))console.log(a)}this._state.paddles[e].running=!1}getFrameCount(e){let t;return this._speed===0?(t=this._oneStep?1:0,this._oneStep=!1):t=e*this._speed,t}run(e){if(this._ended)return;let t=this.getFrameCount(e);for(;t-- >0;){this._state.run();for(let n=0;!this._ended&&n<2;++n){const i=this._state.paddles[n];if(i.score>=this._maxPoints)this._ended=!0;else if(i.running){const{done:a}=this._runners[n].next();a&&this._engineStopped(n)}}}this._speed>0&&this._state.addParticle({x:this._state.ball.x,y:this._state.ball.y,dx:0,dy:0,frames:60*this._speed,className:"ball_spark"})}getEngineState(e){const t=this._engines[e],{operands:n,calls:i}=t;return[`Operands: ${n.length}`,...[...[...ye(n)].map(a=>_e(a,{maxWidth:40})),"","","","",""].slice(0,5),`Call stack: ${i.length}`,...[...ye(i)].map((a,o)=>_e(a,{maxWidth:40,operatorState:i.operatorStateAt(o)}))].join(`
`)}constructor(){this._state=new os}}const R={width:0,height:0},H={width:0,height:0},W={radius:0},ys=s=>{throw new Error(`Unable to find '${s}'`)},O=s=>document.querySelector(s)??ys(s);let xe,ve,ee,Se,ie,lt,pt;const fe=()=>{const e=window.innerWidth/window.innerHeight,t=k/b;e>t?(R.height=Math.max(window.innerHeight-2*50,b/$e),R.width=Math.floor(R.height*t)):(R.width=Math.max(window.innerWidth-2*50,k/$e),R.height=Math.floor(R.width/t)),H.width=Math.ceil(C*R.width/k),H.height=Math.ceil(P*R.height/b),W.radius=Math.ceil(_*R.height/b),ie.setAttribute("style",`width: ${R.width}px; height: ${R.height}px`)};let re,te;const ms=s=>{document.body.innerHTML=`
    <div class="status"></div>
    <div class="board">
      <div class="code player_1">This is an example source code</div>
      <div class="paddle player_1"></div>
      <div class="score player_1">0</div>
      <div class="coords player_1">0,0</div>
      <div class="code player_2">This is an example source code</div>
      <div class="paddle player_2"></div>
      <div class="score player_2">0</div>
      <div class="coords player_2">0,0</div>
      <div class="coords ball">0,0</div>
      <div class='sprite ball'>
        <div class="ball_effect"></div>
      </div>
    </div>
  `,xe=[O(".paddle.player_1"),O(".paddle.player_2")],ve=[O(".score.player_1"),O(".player_2")],Se=[O(".code.player_1"),O(".code.player_2")],ee=[O(".coords.player_1"),O(".coords.player_2"),O(".coords.ball")],ie=O(".board"),lt=O(".sprite.ball"),pt=O(".status"),window.addEventListener("resize",fe),window.addEventListener("load",fe),fe(),re=0,te=ct,requestAnimationFrame(e=>{re=e,requestAnimationFrame(dt.bind(s))})},dt=function(s){const{state:e,speed:t}=this,n=s-re;re=s;const i=Math.floor(1e3/n);te-=n,te<=0&&(pt.innerHTML=`x${t} fps: ${i}/s`,te=ct),xe[0].setAttribute("style",`width: ${H.width}px; height: ${H.height}px; top: ${100*(e.paddles[0].y/b)}%;`),ve[0].innerHTML=e.paddles[0].score.toString(),Se[0].innerHTML=this.getEngineState(0),ee[0].innerHTML=`${e.paddles[0].y} ⇕${e.paddles[0].dy}`,xe[1].setAttribute("style",`width: ${H.width}px; height: ${H.height}px; left: calc(100% - ${H.width}px); top: ${100*(e.paddles[1].y/b)}%;`),ve[1].innerHTML=e.paddles[1].score.toString(),Se[1].innerHTML=this.getEngineState(1),ee[1].innerHTML=`${e.paddles[1].y} ⇕${e.paddles[1].dy}`,lt.setAttribute("style",`width: ${W.radius*2}px; height: ${W.radius*2}px; left: calc(${100*(e.ball.x/k)}% - ${W.radius}px); top: calc(${100*(e.ball.y/b)}% - ${W.radius}px)`),ee[2].innerHTML=`${e.ball.x},${e.ball.y} ⇔${e.ball.dx}⇕${e.ball.dy}`;const a=ie.querySelectorAll(".particle"),o={};for(const p of a.values())o[p.id]=p;const c=[];for(const{id:p,x:d,y:f,className:g,content:w}of e.particles){c.push(p.toString());let y=o[p];y||(y=document.createElement("div"),ie.append(y),y.setAttribute("id",p.toString()),y.setAttribute("class",`particle ${g}`)),y.setAttribute("style",`left: ${100*(d/k)}%; top: ${100*(f/b)}%`),w&&(y.innerHTML=w)}for(const p of a.values()){const{id:d}=p;c.includes(d)||p.remove()}setTimeout(()=>{this.run(Math.ceil(n/4)),requestAnimationFrame(dt.bind(this))},0)},We={follower:`
/main
{
  {
    % Adjust pad position based on current position of the ball
    ball_center_y % ball position
    current_y paddle_height 2 div pop add % center of paddle
    lt
    {
      paddle_up
    }
    {
      paddle_down
    }
    ifelse
  } loop
} bind def
  `,center_or_follow:`
/main
{
  {
    current_y paddle_height 2 div pop add % center of paddle
  
    current_x 0 eq ball_speed_x 0 lt and % left paddle, ball coming
    current_x 0 neq ball_speed_x 0 gt and % right paddle, ball coming
    or
    {
      % follow the ball
      ball_center_y % ball position
    }
    {
      % back to center
      board_height 2 div pop % board center
    }
    ifelse

    lt
    {
      paddle_down
    }
    {
      paddle_up
    }
    ifelse
  } loop
} bind def
`},z=new fs;z.setup({scripts:[We.follower,We.center_or_follow],maxPoints:ut});ms(z);document.addEventListener("keydown",s=>{s.key==="ArrowLeft"?z.decreaseSpeed():s.key==="ArrowRight"?z.increaseSpeed():s.key==="ArrowUp"?z.resetSpeed():s.key==="ArrowDown"&&z.oneStep()});
